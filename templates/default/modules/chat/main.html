<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>..:: CVC Chat Online ::..</title>

        <!-- JQuery Min for Cool Things -->
        <script src="<?php echo javascript_url; ?>jquery-<?php echo get_config('jquery:version'); ?>.min.js" type="text/javascript"></script>
        <script src="<?php echo javascript_url; ?>jquery.color.js" type="text/javascript"></script>
        <script src="<?php echo javascript_url; ?>jquery.hint.js" type="text/javascript"></script>

        <!-- Facebook Connect Library -->
        <script src="http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php/es_LA" type="text/javascript"></script>

        <!-- Finish FBConnect Config -->

        <script type="text/javascript" src="<?php echo javascript_url; ?>jquery.qtip-1.0.0-rc3.min.js"></script>
        <script type="text/javascript" src="<?php echo javascript_url; ?>styleswitch.js"></script>

        <!-- Libreria Javascript del Chat -->
        <!--<script src="<?php echo modules_url; ?>chat/js/chat.js" type="text/javascript"></script>
        <script type="text/javascript">
            init( "<?php echo modules_url; ?>", <?php echo get_config('chat:refresh'); ?> );
        </script>-->

        <style>
            @import url("<? echo modules_url; ?>chat/css/estilo.css");
            @import url("<? echo modules_url; ?>chat/css/taskbar.css");
        </style>

        <link rel="stylesheet" type="text/css" href="<? echo modules_url; ?>chat/css/white.css" title="white" media="screen" />
        <link rel="alternate stylesheet" type="text/css" href="<? echo modules_url; ?>chat/css/black.css" title="black" media="screen" />

    </head>
    <body>

        <!--
            Chat basado en ajax
            Desarrollado por Román A. Sarria
            Cronos Development
        -->

        <script type="text/javascript">
            $(function() {
                $('a[title]').qtip({
                    style: {
                        name: 'dark',
                        tip: true,
                        border: {
                            width: 2,
                            radius: 5,
                            color: '#333333'
                        }
                    },
                    position: {
                        corner: {
                            target: 'topMiddle',
                            tooltip: 'bottomMiddle'
                        }
                    }
                });
            });
        </script>

        <script type="text/javascript">

            function getElapsed( timestamp ) {
                var date = new Date();

                var actual = Math.round( date.getTime() / 1000 );

                var seconds = actual - timestamp;

                var days = Math.floor( seconds / 86400 );

                var mod_hour = ( seconds % 86400 );

                var hour = Math.floor( mod_hour / 3600 );

                var mod_minute = ( mod_hour % 3600 );

                var minute = Math.floor( mod_minute / 60 );

                if( hour <= 0 ) {
                    return minute + " minutos";
                } else if( days <= 0 ) {
                    return hour + " horas " + minute + " minutos";
                } else {
                    return days + " dias " + hour + " horas " + minute + " minutos";
                }
            };

            function reload() {
                                
                return setInterval(function()
                {
                    $("#loadingimage").show();
                    
                    var last = $("#last").val();

                    $.post( "<?php echo modules_url; ?>chat/chat.php" ,
                    {
                        action: "reload",
                        last: last
                    },

                    // Función que se invoca al terminar el script PHP correctamente.
                    function( data ) {
                        if( data.last == -1 ) {
                            $("#loadingimage").hide();
                            return false;
                        }

                        $("#chat").append( data.text );

                        scrollBottom();

                        $("#last").val( data.last );

                        $("#loadingimage").hide();
                    }, "json"
                );
                }, ( parseInt("<?php echo get_config('chat:refresh'); ?>") * (1000) ) );
            };

            function scrollBottom() {
                if( $("#stopupdateimg").attr("src") == "<?php echo modules_url; ?>chat/imgs/application_delete.png" ) return false;

                $("#chat").animate({ 
                    scrollTop: $("#chat").attr("scrollHeight")
                }, "slow");

                document.title = "..:: CVC Chat Online ::.. - Hay nuevos mensajes";
            };

            $(function() {
                var interval;

                $("#loadingimage").show();
                $.post( "<?php echo modules_url; ?>chat/chat.php" ,
                {
                    action: "load"
                },

                // Función que se invoca al terminar el script PHP correctamente.
                function( data ) {
                    $("#chat").append( data.text );

                    scrollBottom();

                    $("#last").val( data.last );
                    $("#loadingimage").hide();
                }, "json"
            );

                interval = reload();

                $("#send").click(function() {
                    $("#loadingimage").show();
                    clearInterval( interval );

                    var name = $("input#name").val();
                    var image = $("img#posterphoto").attr("src");
                    var message = $("textarea#message").val();
                    var fblink = $("input#fblink").val();

                    if( fblink != "" && fblink != "undefined" ) {
                        name = "<a href='" + fblink + "'>" + name + "</a>";
                    }

                    if( name == "" ) {
                        $("input#name").animate({
                            backgroundColor: "red"
                        }, "slow");
                        setTimeout(function(){
                            $("input#name").animate({
                                backgroundColor: "white"
                            }, "slow");
                        }, 2000);

                        interval = reload();
                        $("#loadingimage").hide();
                        return false;
                    }

                    if( message == "" ) {
                        $("textarea#message").animate({
                            backgroundColor: "red"
                        }, "slow");
                        setTimeout(function(){
                            $("textarea#message").animate({
                                backgroundColor: "white",
                                alpha: 0.25
                            }, "slow");
                        }, 2000);

                        interval = reload();
                        $("#loadingimage").hide();
                        return false;
                    }

                    // Aca deberia ir el envio de datos al php que lo inserta en la base de datos.
                    $.post( "<?php echo modules_url; ?>chat/chat.php" ,
                    {
                        action: "add",
                        name: name,
                        image: image,
                        message: message
                    },

                    // Función que se invoca al terminar el script PHP correctamente.
                    function( html ) {
                        if( html.indexOf("true") != -1 ) {
                            $.post( "<?php echo modules_url; ?>chat/chat.php" , { action: "reload", last: $("#last").val() },
                            function( data ) {
                                try {
                                    if( data.last == -1 ) return false;

                                    $("#chat").slideDown("slow").append( data.text );

                                    scrollBottom();

                                    $("#last").val( data.last );
                                } catch(err) {
                                    $("#loadingimage").hide();
                                }
                            }, "json" );
                        }

                        interval = reload();

                        $("textarea#message").val("");
                        $("#loadingimage").hide();
                    }
                );
                });

                $("textarea#message").keypress(function (e) {
                    if (e.which == 13 ) {
                        $("#loadingimage").show();
                        clearInterval( interval );

                        var name = $("input#name").val();
                        var image = $("img#posterphoto").attr("src");
                        var message = $("textarea#message").val();
                        var fblink = $("input#fblink").val();

                        if( fblink != "" && fblink != "undefined" ) {
                            name = "<a href='" + fblink + "'>" + name + "</a>";
                        }

                        if( name == "" ) {
                            $("input#name").animate({
                                backgroundColor: "red"
                            }, "slow");
                            setTimeout(function(){
                                $("input#name").animate({
                                    backgroundColor: "white"
                                }, "slow");
                            }, 2000);

                            interval = reload();
                            $("#loadingimage").hide();
                            return false;
                        }

                        if( message == "" ) {
                            $("textarea#message").animate({
                                backgroundColor: "red"
                            }, "slow");
                            setTimeout(function(){
                                $("textarea#message").animate({
                                    backgroundColor: "white"
                                }, "slow");
                            }, 2000);

                            interval = reload();
                            $("#loadingimage").hide();
                            return false;
                        }

                        // Aca deberia ir el envio de datos al php que lo inserta en la base de datos.
                        $.post( "<?php echo modules_url; ?>chat/chat.php" ,
                        {
                            action: "add",
                            name: name,
                            image: image,
                            message: message
                        },

                        // Función que se invoca al terminar el script PHP correctamente.
                        function( html ) {
                            if( html.indexOf("true") != -1 ) {
                                $.post( "<?php echo modules_url; ?>chat/chat.php" , { action: "reload", last: $("#last").val() },
                                function( data ) {
                                    try {
                                        if( data.last == -1 ) return false;

                                        $("#chat").slideDown("slow").append( data.text );

                                        scrollBottom();

                                        $("#last").val( data.last );
                                    } catch(err) {
                                        $("#loadingimage").hide();
                                    }
                                }, "json" );
                            }

                            interval = reload();

                            $("textarea#message").val("");
                            $("#loadingimage").hide();
                        }
                    );
                    }
                });

                $("#stopupdate").click(function() {
                    if( $("#stopupdateimg").attr("src") == "<?php echo modules_url; ?>chat/imgs/application_put.png" ) {
                        $("#stopupdateimg").attr("src", "<?php echo modules_url; ?>chat/imgs/application_delete.png");
                    } else {
                        $("#stopupdateimg").attr("src", "<?php echo modules_url; ?>chat/imgs/application_put.png");
                    }
                });

                $("#sendsuggest").click( function(){

                    var url_send = "<?php echo actions_url; ?>mail.php";

                    var to = "agustin478@gmail.com";
                    var subject = "Sugerencia Chat";

                    var name = $("input#suggestname").val();
                    var mail = $("input#suggestemail").val();
                    var comment = $("textarea#suggest").val();

                    var msg = "Nombre: " + name + "<br />E-Mail: " + mail + "<br /><br />Sugerencia: " + comment;

                    if( name == "" || mail == "" || comment == "" ) {
                        $("#response").fadeIn('slow');
                        $("#response").text("Faltan completar campos");

                        setTimeout(function() {
                            $("#response").fadeOut('slow');
                        }, 2000);

                        return false;
                    }

                    if( mail.indexOf("@") == -1 ) {
                        $("#response").fadeIn('slow');
                        $("#response").text("El correo electronico no es válido");

                        setTimeout(function() {
                            $("#response").fadeOut('slow');
                        }, 2000);

                        return false;
                    }

                    var vars = "to=" + to + "&subject=" + subject + "&msg=" + msg;
                    $.ajax({
                        type: "POST",
                        url: url_send,
                        data: vars,
                        success: function(html) {
                            $("#response").fadeIn('slow');
                            $("#response").text(html);

                            $("input#suggestname").val("");
                            $("input#suggestemail").val("");
                            $("textarea#suggest").val("");

                            setTimeout(function() {
                                $("#response").fadeOut('slow');
                                $("#suggestion").slideToggle('slow');
                            }, 2000);
                        }
                    });
                    return false;
                });

                $(window).focus(function(){
                    setTimeout(function(){
                        document.title = "..:: CVC Chat Online ::..";
                    }, 3000);
                });
            });
        </script>

        <div id="taskbar">
            <div id="container">
                <div class="block-left">
                    <a href="#" class="btns" onclick="$('#suggestion').slideToggle();">Sugerencias</a>
                </div>
                <div class="block-center">
                    <!--                    <a href="" class="btns"><img src="img/application.png" class="alignleft" alt="aplicacion" /></a>
                                        <a href="" class="btns"><img src="img/calculator.png" class="alignleft" alt="aplicacion" />Twitter</a>
                                        <a href="" class="btns"><img src="img/clock_red.png" alt="aplicacion" /></a>
                                        <a href="" class="btns"><img src="img/zoom.png" alt="aplicacion" /></a>-->
                    <div style="height:19px;padding:3px;display:inline-block;vertical-align:middle;line-height:14px;" id="loadingimage"><img src="<?php echo modules_url; ?>chat/imgs/mini_loading.gif" /></div>
                </div>
                <div class="block-right">
                    <a href="#" onclick="$('#help').slideToggle();" id="helpbutton" class="btns"><img src="<?php echo modules_url; ?>chat/imgs/help.png" alt="Ayuda" title="Ayuda" /></a>
                    <a href="#" id="stopupdate" class="btns"><img id="stopupdateimg" src="<?php echo modules_url; ?>chat/imgs/application_put.png" alt="Actualizacion" title="Desactivar scroll" /></a>
                    <a href="#" class="btns" onclick="$('#colorselector').slideToggle();"><img src="<?php echo modules_url; ?>chat/imgs/color_swatch.png" alt="Cambiar estilo" title="Cambiar estilo" /></a>
                </div>
            </div>
        </div>

        <div id="colorselector">
            <a href="#" id="whitecolor" rel="white" class="styleswitch" ></a>
            <a href="#" id="blackcolor" rel="black" class="styleswitch" ></a>
        </div>

        <div id="suggestion">
            <form>
                <label for="name">Nombre: </label><br/><input type="text" name="name" id="suggestname" /><br/>
                <label for="email">E-Mail: </label><br/><input type="text" name="email" id="suggestemail" /><br/>
                <label for="suggest">Sugerencia: </label><br/>
                <textarea name="suggest" id="suggest"></textarea><br/>
                <div id="response"></div>
                <input type="button" id="sendsuggest" value="Enviar" />
            </form>
        </div>

        <div id="help">
            <span style="font-size: 15px; display: inline-block; margin-top: 10px;"><strong><u>Ayuda</u></strong></span>
            <span><strong><br/>Códigos de Estilo (BBCode)</strong></span>
            <p><strong>Colores:</strong><br/>
                [color=COLOR]Texto[/color]<br/>
                [c=COLOR]Texto[/c]<br/><br/>
                <strong>Negrita:</strong><br/>
                [b]Texto[/b]<br/><br/>
                <strong>Subrayado:</strong><br/>
                [u]Texto[/u]<br/><br/>
                <strong>Url:</strong><br/>
                [url]Direccion HTTP[/url]<br/><br/>
                <strong>Alineación:</strong><br/>
                [align=POSICION]Texto[/align]<br/>
                La posición puede ser left/center/right.<br/><br/>
                <strong>Fuente:</strong><br/>
                [font=TIPOGRAFIA]Texto[/font]<br/><br/>
                <strong>Salto de Línea:</strong><br/>
                Texto[br]Texto<br/>
                El texto que este ubicado luego de la etiqueta saldrá en la linea siguiente.<br/><br/>
                Desarrollado por:<br/>
                <strong>Román A. Sarria</strong>
            </p>
        </div>

        <input type="hidden" id="last" />

        <div id="chat">

        </div>

        <div id="postmessage">
            <form id="form1" name="form1" method="post" action="">
                <div id="posting">
                    <div id="photo"><img id="posterphoto" width="46" height="46" src="<? echo template_url; ?>imgs/red/users/noPic-user.jpg" id="posterphoto" /></div>
                    <div id="writemsg">
                        <div id="writename">
                            <input type="text" name="name" title="Nombre y Apellido" style="width: 420px; border: 1px #CCC solid;" id="name" />
                            <input type="hidden" name="fblink" id="fblink" />
                        </div>
                        <div id="writemessage">
                            <textarea name="message" title="Mensaje..." id="message" style="width: 420px; border: 1px #CCC solid;" rows="5"></textarea>
                        </div>
                    </div>
                </div>
                <?php $browser = new Browser();
                if( $browser->getBrowser() == Browser::BROWSER_IE ) { ?>
                <div id="browsers">
                    <div id="browsertext"><span><strong>Para usar tu foto descarga uno de estos navegadores: </strong></span></div>
                    <div id="browser"><a href="http://www.google.com/chrome/" target="_BLANK" alt="Chrome"><img src="<?php echo modules_url; ?>chat/imgs/chrome.jpg" alt="Chrome"/></a></div>
                    <div id="browser"><a href="http://www.mozilla.com/" target="_BLANK" alt="Firefox"><img src="<?php echo modules_url; ?>chat/imgs/firefox.jpg" /></a></div>
                    <div id="browser"><a href="http://www.apple.com/safari/" target="_BLANK" alt="Safari"><img src="<?php echo modules_url; ?>chat/imgs/safari.jpg"/></a></div>
                    <div id="browser"><a href="http://www.opera.com/" target="_BLANK" alt="Opera"><img src="<?php echo modules_url; ?>chat/imgs/opera.jpg"/></a></div>
                </div>
                <?php } else { ?>
                <div id="fbbutton" class="fblogin">
                    <fb:login-button v="2" size="medium" onlogin="update_user_box(0);">Conectar</fb:login-button>
                </div>
                <div id="fbbutton" class="fblogout" style="display: none;">
                    <input type="button" id="logout" onclick="FB.Connect.logout(function(){ fbDisconnect(); });" value="Desconectarse" />
                    <input type="button" id="logout" style="margin-right: 1px;" onclick="fbShare();" value="Compartir" />
                </div>
                <?php } ?>
                <input type="button" name="send" id="send" value="Enviar" />
            </form>
        </div>

        <div id="fbdata" style="display: none;">
            <fb:profile-pic uid="loggedinuser" size="square" facebook-logo="true"></fb:profile-pic>
        </div>

        <!-- style="display: none;" -->

        <script type="text/javascript">
            FB.init("e8da4f715e29dee16c39f464969ab3ef","<?php echo base_url; ?>xd_receiver.htm");

            $(function(){
                update_user_box(0);
                
                $("textarea#message").focus();
            });

            function fbShare() {
                window.open('http://www.facebook.com/share.php?u=<?php echo base_url; ?>index.php?url=chat','Compartir','menubar=no,toolbar=no,resizable=no,scrollbars=no,status=no,width=620,height=250');

                $('textarea#message').val('He compartido este chat en Facebook, has lo mismo! Conectate a Facebook desde este chat y clickea en el boton Compartir!');

                $("#send").click();
            }

            function fbDisconnect() {
                $("#posterphoto").attr("src", "<? echo template_url; ?>imgs/red/users/noPic-user.jpg" );

                $("input#name").val( "" );
                $("input#fblink").val( "" );
                $("input#name").attr("readOnly", false);

                $(".fblogin").show();
                $(".fblogout").hide();

                $("input#name").focus();
            }
    
            function update_user_box(count) {
                $(function() {
                    var value = $("#fbdata").html();

                    var fbimage = value.substring( (value.indexOf("<img src=\"") + "<img src=\"".length ), value.indexOf("\"", (value.indexOf("<img src=\"") + "<img src=\"".length ) ) );
                    var fbname = value.substring( (value.indexOf("alt=\"") + "alt=\"".length ), value.indexOf("\"", (value.indexOf("alt=\"") + "alt=\"".length ) ) );
                    var fblink = value.substring( (value.indexOf("href=\"") + "href=\"".length ), value.indexOf("\"", (value.indexOf("href=\"") + "href=\"".length ) ) );

                    if( fbimage.indexOf("url=") != -1 ) {
                        fbimage = fbimage.substring( (fbimage.indexOf("url=") + "url=".length ), ( fbimage.length - 8 ) );
                        //    fbimage = fbimage.substring( 0, ( fbimage.length - 8 ) );
                    }

                    fbimage = fbimage.replace(new RegExp ("&amp;", 'g'), "&");
                    fbimage = fbimage.replace(new RegExp ("%3A", 'g'), ":");
                    fbimage = fbimage.replace(new RegExp ("%2F", 'g'), "/");

                    if( fbimage == "" || fbname == "" || fblink == "" ||
                        fbimage.indexOf("http://") == -1 || fblink.indexOf("http://") == -1) {
                        if( count == 5 ) {
                            //alert("Ha habido un error al intentar sincronizar su cuenta de facebook.");
                            return false;
                        }
                        count++;
                        setTimeout(function() {
                            update_user_box( count );
                        }, 1000);
                        return false;
                    }

                    $("#posterphoto").attr("src", fbimage );

                    $("input#name").val( fbname );
                    $("input#fblink").val( fblink );
                    $("input#name").attr("readOnly", true);

                    $(".fblogin").hide();
                    $(".fblogout").show();

                    $("textarea#message").focus();
                });

            };
        </script>

        <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <script type="text/javascript">
            try{
                var pageTracker = _gat._getTracker("<?php echo get_config('google:analytics'); ?>");
                pageTracker._trackPageview();
            } catch(err) {}
        </script>

    </body>
</html>